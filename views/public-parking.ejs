<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Public Parking - Parking Management System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="/public">Parking System</a>
    </div>
  </nav>
  <div class="container mt-4">
    <h2>Public Parking Interface</h2>
    <button id="subscribeButton" class="btn btn-info mb-3">Enable Notifications</button>
    <% if (typeof error !== 'undefined' && error && error !== 'null') { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>
    <% if (typeof validationErrors !== 'undefined' && Array.isArray(validationErrors) && validationErrors.length > 0) { %>
      <div class="alert alert-danger">
        <ul>
          <% validationErrors.forEach(function(error) { %>
            <li><%= error %></li>
          <% }) %>
        </ul>
      </div>
    <% } %>
    <% if (Array.isArray(lots) && lots.length > 0) { %>
      <% lots.forEach(function(lot) { %>
        <div class="card mb-3">
          <div class="card-body">
            <p><strong>Total Spaces:</strong> <%= lot && lot.totalSpaces !== undefined ? lot.totalSpaces : 0 %></p>
            <p><strong>Available Spaces:</strong> <%= lot && lot.available !== undefined ? lot.available : 0 %></p>
            <h5>Pricing</h5>
            <% if (lot && Array.isArray(lot.categories) && lot.categories.length > 0) { %>
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Pricing Type</th>
                    <th>Price</th>
                  </tr>
                </thead>
                <tbody>
                  <% lot.categories.forEach(function(category) { %>
                    <tr>
                      <td><%= category && category.name ? category.name : 'N/A' %></td>
                      <td><%= category && category.pricing_type ? category.pricing_type : 'N/A' %></td>
                      <td>$<%= category && category.price !== undefined ? Number(category.price).toFixed(2) : '0.00' %></td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            <% } else { %>
              <p>No categories available.</p>
            <% } %>
            <h5>Park Your Vehicle</h5>
            <form action="/public/park" method="POST">
              <div class="mb-3">
                <label for="number_plate" class="form-label">Number Plate</label>
                <input type="text" class="form-control" id="number_plate" name="number_plate" value="<%= autofill && autofill.number_plate ? autofill.number_plate : '' %>" required>
                <small class="form-text text-muted">3-10 characters, uppercase letters and numbers only (e.g., ABC123)</small>
              </div>
              <div class="mb-3">
                <label for="owner_name" class="form-label">Owner Name (Optional)</label>
                <input type="text" class="form-control" id="owner_name" name="owner_name" value="<%= autofill && autofill.owner_name ? autofill.owner_name : '' %>">
                <small class="form-text text-muted">1-50 characters, letters and spaces only</small>
              </div>
              <div class="mb-3">
                <label for="phone" class="form-label">Phone (Optional)</label>
                <input type="text" class="form-control" id="phone" name="phone" value="<%= autofill && autofill.phone ? autofill.phone : '' %>">
                <small class="form-text text-muted">10-15 digits</small>
              </div>
              <div class="mb-3">
                <label for="category_id" class="form-label">Vehicle Category</label>
                <select class="form-select" id="category_id" name="category_id" required>
                  <% lot.categories.forEach(function(category) { %>
                    <option value="<%= category && category.id ? category.id : '' %>" <%= autofill && autofill.category_id == category.id ? 'selected' : '' %>>
                      <%= category && category.name ? category.name : 'N/A' %>
                    </option>
                  <% }) %>
                </select>
              </div>
              <button type="submit" class="btn btn-primary">Park and Get Ticket</button>
            </form>
          </div>
        </div>
      <% }) %>
    <% } else { %>
      <p>No parking available.</p>
    <% } %>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Notification subscription
    const subscribeButton = document.getElementById('subscribeButton');
    subscribeButton.addEventListener('click', async () => {
      if ('serviceWorker' in navigator && 'PushManager' in window) {
        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js');
          const permission = await Notification.requestPermission();
          if (permission === 'granted') {
            const subscription = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: await fetch('/vapidPublicKey').then(res => res.text())
            });
            await fetch('/subscribe', {
              method: 'POST',
              body: JSON.stringify(subscription),
              headers: { 'Content-Type': 'application/json' }
            });
            alert('Notifications enabled!');
            subscribeButton.disabled = true;
          }
        } catch (err) {
          console.error('Notification subscription error:', err);
          alert('Failed to enable notifications');
        }
      } else {
        alert('Notifications not supported in this browser');
      }
    });
  </script>
</body>
</html>